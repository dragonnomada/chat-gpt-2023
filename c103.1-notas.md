# Clase 103 - Introducci√≥n a la librer√≠a OpenAI para Python

> **Centro de Investigaci√≥n en Computaci√≥n**
>
> *Instituto Polit√©cnico Nacional*
>
> Departamento de Diplomados y Extensi√≥n Profesional
>

![CIC-IPN](https://www.cic.ipn.mx/images/logos/logositiocicletras.png)

**Profesor**: [Alan Badillo Salas](alan@nomadacode.com)

---

## Contenido

    1. Modelos y an√°lisis de textos
        - Modelos de texto
        - Expresiones regulares
        - Extracci√≥n del vocabulario
        - Vectorizaci√≥n de palabras
        - Conteos y frecuencias
        - Probabilidad de ocurrencias
        - N-Gramas
    2. Introducci√≥n a la librer√≠a OpenAI para Python
        - Instalaci√≥n y configuraci√≥n de la librer√≠a
        - Usar Chat Completion 

## Objetivos

Aprender a realizar instrucciones desde Python hacia CHATGPT. Cargar las instrucciones desde archivos de texto y archivos CSV. Establecer un flujo de trabajo automatizado para la resoluci√≥n de tareas cargadas desde archivos de texto/CSV y dirigidas hacia archivos de texto/CSV.

## Introducci√≥n

CHATGPT es una herramienta que nos permite procesar y analizar de manera inteligente textos, adem√°s de la posibilidad de utilizarlo como un asistente de programaci√≥n.

Podemos ver a CHATGPT en dos aplicaciones directas:

1. Como un asistente que nos recupera informaci√≥n compleja de un texto, por ejemplo, darle un texto y solicitarle un resumen, las palabras claves, los personajes involucrados, las situaciones identificadas, si hablan bien o mal de un personaje, si se menciona una instituci√≥n, los precios y fechas mencionadas, n√∫meros de tel√©fonos, correos y cuentas bancarias mecionadas, entre un sin fin m√°s. Esto supera incluso a un buen asistente humano.
2. Como un asistente que genere el c√≥digo necesario para resolver una tarea, por ejemplo, un c√≥digo en Python que abra un archivo CSV, extra√≠ga los datos de las columnas SALARIO y NIVEL_EDUCATIVO y cree una gr√°fica de correlaci√≥n entre ambas, y finalmente escriba ambas columnas en un archivo CSV. Esto tambi√©n supera por mucho a un humano est√°ndar en cu√°nto a tiempo de respuesta. Mientras un programador podr√≠a perder tiempo investigando c√≥mo resolver el problema, en cuesti√≥n de segundos CHATGPT nos dar√≠a los c√≥digos.

Con esto en mente, usaremos a CHATGPT como nuestro asistente personal para hacer **An√°lisis de Textos** en una forma avanzada.

## Modelos y an√°lisis de textos

Los an√°lisis cl√°sicos sobre los textos consisten identificar las palabras de mayor frecuencia, extraer patrones regulares, vectorizar las palabras, hacer conteos y frecuencia de palabras y analizar los n-gramas.

Con esto en mente vamos a dise√±ar una serie funciones para Python, que automaticen nuestro flujo de an√°lisis de textos.

### Modelos de texto

Un modelo de texto implica entender la estructura b√°sica del texto, por ejemplo, si se trata de una noticia, podremos ubicar un t√≠tulo, fecha, autor y el contenido de la noticia. Dentro de ese modelo podr√≠amos determinar patrones de b√∫squeda para reconocer los datos dentro del texto.

Algunos modelos cl√°sicos son:

- **Textos que mencionan fechas** - Ejemplo: `2023-03-12`, `12/03/2023`, `marzo 12, 2023`, `12 de marzo del 2023`, `march 12th, 2023`, `el 12 de marzo del a√±o actual`, `el d√≠a 12, del mes de marzo del 2023`, `hace dos d√≠as (suponiendo que hoy es 14 de marzo del 2023)`, `antier (suponiendo que hoy es 14 de marzo del 2023)`.
- **Textos que mencionan precios** - Ejemplo: `$1,234.56`, `mil docientos treinta y cuatro con 56 centavos`, `con un precio de dos millones con 76 pesos`.
- **Textos que mencionan tel√©fonos, correos, cuentas y m√°s** - Ejemplo: `ana.ming@gmail.com`, `@dragonnomada`, `https://www.ballena.app`, `+52 1 551 234 5678`, `llamale al 55238890 con la extensi√≥n 24`, `la cuenta es 5212349988833322`, `m√°ndale un correo a pepe123 arroba gmail punto com`, `el n√∫mero de referencia es 445633`.
- **Textos que mencionan personas, instituciones, paises y m√°s** - `dile a Ana Ming que me pague`, `La UNESCO acept√≥ que la tierra es patrimonio de la humanidad`, `En dos d√≠as X ser√° la nueva red social y dejar√° de ser Twitter`, `alguien sabe como se escribe feisbuq?`, `vamos a Jap√≥n a comernos una hamburguesa a ver si se parece a la original`.

Podemos observar que dentro de los modelos de texto, algunos son m√°s regulares que otros, por ejemplo, si quisieramos reconocer una fecha, ser√≠a m√°s f√°cil reconocer `12/03/2023` que `antier`. Esta √∫ltima requerir√≠a mucha inteligencia para determinar que esa palabra es una fecha.

### Expresiones regulares

Las expresiones regulares son conjuntos de MARCADORES que nos permiten reconocer dentro de un texto patrones reguales, por ejemplo:

* `[A-Z]+` - Reconoce dentro de un texto uno o m√°s caracteres consecutivos entre la `A` y la `Z`, por ejemplo, dentro del texto: `La UNESCO acept√≥ que la TIERRA es patrimonio de la humanidad`, ser√≠a capaz de reconocer: `L`, `UNESCO` y `TIERRA`, ya que estas cumplen el patr√≥n regular.
* `[a-z\.\-\_]+@[a-z]+\.com` - Reconoce dentro de un texto caracteres en min√∫scula de la `a` a la `z`, signos de `.`, `-` y `_` antes de una arroba (`@`), seguido de m√°s de un caracter entre `a` y `z`, previos a un `.com`, por ejemplo, ser√≠a capaz de reconocer dentro del texto: `Los correos son: pepe@gmail.com, dany_23@hotmail.com, pedro-99@el-diario.com y paty.123@example.gob`, solo los siguientes correos: `pepe@gmail.com` y `dany_23@hotmail.com`. Porque `el-diario` no se apega al patr√≥n regular y `.gob` tampoco.

Extraer datos usando expresiones regulares es bastante limitado en un an√°lisis real, ya que s√≥lo podr√≠amos reconocer patrones reguales como `12/03/23` o `15/08/2024` mediante el patr√≥n `\d{2}\/\d{2}\/\d{2}`, sin embargo, reconocer `el d√≠a dos de abril del 2023`, ser√≠a bastante complejo lograrlo.

CHATGPT adquiere una ventaja en an√°lisis de patrones regulares y para demostrarlo hagamos las siguientes solicitudes:

```text

SOLICITUDES A CHATGPT:

=== .1

Del siguiente texto:

- **Textos que mencionan fechas** - Ejemplo: `1963-08-01`, `24/02/1966`, `agosto 21, 2023`, `22 de julio de 1987`, `feb 14th, 1994`, `el 7 de octubre del 98`, `el d√≠a 12, del mes de agosto del 2023`, `hace dos d√≠as (suponiendo que hoy es 15 de marzo de 1990)`, `antier (suponiendo que hoy es 1 de julio del 2021)`.

Recupera todas las fechas en forma de lista en el formato ISO

--- RESPUESTA ---

Aqu√≠ tienes la lista de fechas recuperadas del texto en formato ISO:

- `1963-08-01`
- `1966-02-24`
- `2023-08-21`
- `1987-07-22`
- `1994-02-14`
- `1998-10-07`
- `2023-08-12`
- `1990-03-13` (hace dos d√≠as a partir del 15 de marzo de 1990)
- `2021-06-29` (antier a partir del 1 de julio de 2021)

Ten en cuenta que en el √∫ltimo caso ("antier") hubo una discrepancia entre la fecha que proporcionaste (1 de julio del 2021) y el resultado que obtuviste (antier a partir del 1 de julio de 2021). El resultado proporcionado es coherente con la fecha que diste.

=== .2

Dame la lista de los d√≠as de la semana para cada fecha de la lista anterior

--- RESPUESTA ---

Aqu√≠ tienes la lista de los d√≠as de la semana correspondientes a cada fecha de la lista anterior:

- `1963-08-01`: Martes
- `1966-02-24`: Jueves
- `2023-08-21`: Lunes
- `1987-07-22`: Mi√©rcoles
- `1994-02-14`: Lunes
- `1998-10-07`: Mi√©rcoles
- `2023-08-12`: S√°bado
- `1990-03-13`: Martes (hace dos d√≠as a partir del 15 de marzo de 1990)
- `2021-06-29`: Martes (antier a partir del 1 de julio de 2021)

Si necesitas m√°s informaci√≥n o ayuda, no dudes en preguntar.

=== .3

Dame la lista de precios en formato $X,XXX.YY del texto siguiente:

- **Textos que mencionan precios** - Ejemplo: `$1,234.56`, `mil docientos treinta y cuatro con 56 centavos`, `con un precio de dos millones con 76 pesos`.

--- RESPUESTA ---

Lamento informarte que mi capacidad para interpretar y convertir n√∫meros en palabras es limitada, y no tengo la capacidad de realizar conversiones complejas entre n√∫meros escritos en palabras y formatos num√©ricos. Sin embargo, puedo ayudarte con otras consultas o tareas. Si tienes alguna otra pregunta o solicitud, no dudes en dec√≠rmelo.

=== .4

Dame la lista de n√∫meros que seas capaces de reconocer del siguiente texto:

- **Textos que mencionan precios** - Ejemplo: `$1,234.56`, `mil docientos treinta y cuatro con 56 centavos`, `con un precio de dos millones con 76 pesos`.

--- RESPUESTA ---

Entiendo. Aqu√≠ tienes la lista de n√∫meros que puedo reconocer del texto:

- `$1,234.56`
- `mil docientos treinta y cuatro con 56 centavos`
- `dos millones con 76 pesos`

Si tienes alguna otra pregunta o necesitas m√°s ayuda, no dudes en preguntar.

=== .5

Puedes convertir la lista anterior en n√∫meros?

--- RESPUESTA ---

Claro, puedo ayudarte a convertir la lista de n√∫meros en formatos legibles. Aqu√≠ tienes la conversi√≥n de los n√∫meros:

- `$1,234.56`: 1234.56
- `mil docientos treinta y cuatro con 56 centavos`: 1230.56
- `dos millones con 76 pesos`: 2000076.00

Si tienes m√°s preguntas o necesitas m√°s ayuda, no dudes en preguntar.

```

> **EJERCICIO:** Dise√±a un modelo de texto que involucre personajes, fechas, lugares, productos, precios, cuentas o n√∫meros de tel√©fonos y establece una serie de preguntas para recuperar la informaci√≥n del texto, por ejemplo, ¬øQu√© personas est√°n involucradas en el texto?

### Extracci√≥n del vocabulario

Para un texto de tama√±o medio (100 palabras o m√°s), recupera las palabras distintas y pide a CHATGPT que te diga la relevancia de cada palabra. 

### Vectorizaci√≥n de palabras

Para un texto de tama√±o medio (100 palabras o m√°s), pide la lista n√∫merada de todas las palabras distintas ordenadas alfabeticamente. 

### Conteos y frecuencias

Para un texto de tama√±o medio (100 palabras o m√°s), recupera el conteo o repetici√≥n de cada palabra y la frecuencia con la que se repite respecto a otras.

### Probabilidad de ocurrencias

Para un texto de tama√±o medio (100 palabras o m√°s), recupera la probabilidad de que cada palabra ocurra.

### N-Gramas

Para un texto de tama√±o medio (100 palabras o m√°s), recupera los n-gramas, es decir, las palabras consecutivas de **n-en-n**, por ejemplo, los n-gramas de 4 en 4 (deber√≠a mostrar conjuntos consecutivos de 4 en 4 palabras que vayan ocurriendo sobre el texto).

## Introducci√≥n a la librer√≠a OpenAI para Python

Podemos hacer consultas a CHAGPT directamente desde Python usando la librer√≠a de **OpenAI** para Python.

### Instalaci√≥n y configuraci√≥n de la librer√≠a

Para hacer consultas a ChatGPT utilizando la librer√≠a de OpenAI en Google Colab, puedes seguir los siguientes pasos:

1. Instala la librer√≠a de OpenAI si a√∫n no lo has hecho. Puedes hacerlo ejecutando el siguiente comando en una celda de c√≥digo en Google Colab:

```python
!pip install openai
```

2. Importa la librer√≠a y configura tu clave de API. Necesitar√°s tu clave de API de OpenAI para autenticarte. Puedes obtenerla desde tu cuenta en la plataforma de OpenAI.

> 

```python
import openai

openai.api_key = "TU_CLAVE_DE_API"
```

3. Realiza una consulta a ChatGPT. Puedes usar la funci√≥n `openai.Completion.create()` para generar una respuesta del modelo. Aqu√≠ tienes un ejemplo:

> [https://platform.openai.com/account/rate-limits](https://platform.openai.com/account/rate-limits)

```python
response = openai.Completion.create(
    engine="davinci-codex",  # Puedes usar "text-davinci-003" si prefieres GPT-3
    prompt="Dime algo interesante sobre la historia de la humanidad.",
    max_tokens=50  # Puedes ajustar este valor seg√∫n la longitud deseada de la respuesta
)

print(response.choices[0].text.strip())
```

Recuerda reemplazar `"TU_CLAVE_DE_API"` con tu clave de API real.

4. Ejecuta la celda para obtener la respuesta generada por el modelo.

Es importante tener en cuenta que la librer√≠a de OpenAI y los detalles de su uso pueden cambiar con el tiempo. Aseg√∫rate de consultar la documentaci√≥n oficial de OpenAI para obtener la informaci√≥n m√°s actualizada sobre c√≥mo interactuar con sus modelos utilizando Python.

Ten en cuenta tambi√©n que el modelo "davinci-codex" es especialmente bueno para tareas de programaci√≥n y generaci√≥n de texto basado en c√≥digo. Si prefieres utilizar GPT-3 para tareas m√°s generales, puedes reemplazar "davinci-codex" con "text-davinci-003".

### Usar Chat Completion

Las cuotas para usar CHATGPT desde el API est√°n bastante limitadas. Yo pagu√© la subscripci√≥n de CHATGPT-4 PLUS pero es solo en chat, para las llamadas en API no cubre la tarifa de $20 d√≥lares, por lo que no conviene pagarlo ya que el modelo tambi√©n est√° entrenado hasta septiembre del 2021, no hay mejoras notables entre la versi√≥n 3.5 desafortunadamente.

Para usar el API con pago debes ingresar a [https://platform.openai.com/account](https://platform.openai.com/account) la cual tambi√©n se pag√≥ ü•≤ y gener√≥ un costo de $5 d√≥lares por la activaci√≥n (no s√© si reembolsables ü•≤ü•≤). Esto requiere configurar el m√©todo de pago. Cada consulta generar√° algunos centavos de uso. Aunque se pueden generar claves del API sin hacer ning√∫n pago.

Realizaremos el siguiente ejercicio para probar la funcionalidad de CHATGPT con Python.

Todos los c√≥digos est√°n probados en Google Colab.

![Uso de CHATGPT via API](./screenshots/c103/image.png)

En la siguiente lista se muestran los modelos disponibles y sus l√≠mites:

| MODEL                                      | TPM          | RPM   |
|--------------------------------------------|--------------|-------|
| **CHAT**                                   |              |       |
| gpt-3.5-turbo                              | 90,000       | 3,500 |
| gpt-3.5-turbo-0301                         | 90,000       | 3,500 |
| gpt-3.5-turbo-0613                         | 90,000       | 3,500 |
| gpt-3.5-turbo-16k                          | 180,000      | 3,500 |
| gpt-3.5-turbo-16k-0613                     | 180,000      | 3,500 |
| **TEXT**                                   |              |       |
| ada                                        | 250,000      | 3,000 |
| ada-code-search-code                       | 250,000      | 3,000 |
| ada-code-search-text                       | 250,000      | 3,000 |
| ada-search-document                        | 250,000      | 3,000 |
| ada-search-query                           | 250,000      | 3,000 |
| ada-similarity                             | 250,000      | 3,000 |
| babbage                                    | 250,000      | 3,000 |
| babbage-code-search-code                   | 250,000      | 3,000 |
| babbage-code-search-text                   | 250,000      | 3,000 |
| babbage-search-document                    | 250,000      | 3,000 |
| babbage-search-query                       | 250,000      | 3,000 |
| babbage-similarity                         | 250,000      | 3,000 |
| code-davinci-edit-001                      | 150,000      | 20    |
| code-search-ada-code-001                   | 250,000      | 3,000 |
| code-search-ada-text-001                   | 250,000      | 3,000 |
| code-search-babbage-code-001               | 250,000      | 3,000 |
| code-search-babbage-text-001               | 250,000      | 3,000 |
| curie                                      | 250,000      | 3,000 |
| curie-instruct-beta                        | 250,000      | 3,000 |
| curie-search-document                      | 250,000      | 3,000 |
| curie-search-query                         | 250,000      | 3,000 |
| curie-similarity                           | 250,000      | 3,000 |
| davinci                                    | 250,000      | 3,000 |
| davinci-instruct-beta                      | 250,000      | 3,000 |
| davinci-search-document                    | 250,000      | 3,000 |
| davinci-search-query                       | 250,000      | 3,000 |
| davinci-similarity                         | 250,000      | 3,000 |
| text-ada-001                               | 250,000      | 3,000 |
| text-babbage-001                           | 250,000      | 3,000 |
| text-curie-001                             | 250,000      | 3,000 |
| text-davinci-001                           | 250,000      | 3,000 |
| text-davinci-002                           | 250,000      | 3,000 |
| text-davinci-003                           | 250,000      | 3,000 |
| text-davinci-edit-001                      | 150,000      | 20    |
| text-embedding-ada-002                     | 1,000,000    | 3,000 |
| text-search-ada-doc-001                    | 250,000      | 3,000 |
| text-search-ada-query-001                  | 250,000      | 3,000 |
| text-search-babbage-doc-001                | 250,000      | 3,000 |
| text-search-babbage-query-001              | 250,000      | 3,000 |
| text-search-curie-doc-001                  | 250,000      | 3,000 |
| text-search-curie-query-001                | 250,000      | 3,000 |
| text-search-davinci-doc-001                | 250,000      | 3,000 |
| text-search-davinci-query-001              | 250,000      | 3,000 |
| text-similarity-ada-001                    | 250,000      | 3,000 |
| text-similarity-babbage-001                | 250,000      | 3,000 |
| text-similarity-curie-001                  | 250,000      | 3,000 |
| text-similarity-davinci-001                | 250,000      | 3,000 |
| **MODERATION**                             |              |       |
| text-moderation-latest                     | 150,000      | 1,000 |
| text-moderation-stable                     | 150,000      | 1,000 |
| **IMAGE**                                  |              |       |
| DALL¬∑E 2                                   | 50 IMG/MIN   | ‚àû     |
| **AUDIO**                                  |              |       |
| whisper-1                                  | 25,000,000   | 50    |
| **OTHER**                                  |              |       |
| Default limits for all other models        | 250,000      | 3,000 |

La columna "TPM" en la tabla que proporcionaste se refiere a "Tokens Per Minute". Un "token" en el contexto de modelos de lenguaje como los de OpenAI puede ser tan corto como un car√°cter o tan largo como una palabra. Por ejemplo, la frase "ChatGPT es genial" se divide en cinco tokens: ["Chat", "G", "PT", " es", " genial"].

Los l√≠mites de tokens por minuto (TPM) indican cu√°ntos tokens puede procesar un usuario espec√≠fico o una aplicaci√≥n utilizando un modelo particular en el transcurso de un minuto. Es una forma de medir y limitar el uso, especialmente cuando est√°s interactuando con el modelo a trav√©s de una API.

El TPM es importante porque los modelos de lenguaje, especialmente los grandes, pueden consumir muchos recursos computacionales al procesar texto. Limitar el n√∫mero de tokens procesados por minuto ayuda a evitar un uso excesivo y garantiza que los recursos est√©n disponibles para todos los usuarios.

La columna "RPM" en la tabla se refiere a "Requests Per Minute". Es una medida de cu√°ntas solicitudes individuales un usuario o una aplicaci√≥n puede hacer a un modelo en particular a trav√©s de una API en el transcurso de un minuto.

Esto es especialmente relevante para aplicaciones y desarrolladores que utilizan la API de OpenAI (u otras APIs similares) para interactuar con modelos de lenguaje. El l√≠mite de RPM est√° dise√±ado para controlar el tr√°fico hacia el modelo y garantizar que el servicio se mantenga estable y disponible para todos los usuarios. Si una aplicaci√≥n o usuario supera el l√≠mite de RPM, es probable que las solicitudes adicionales sean rechazadas hasta que el n√∫mero de solicitudes se reduzca por debajo del l√≠mite permitido.

**NOTA:** El c√≥digo anterior no funcion√≥ para modelos de chat, por lo que me sugiri√≥ cambiar mi c√≥digo:

> Respuesta de CHATGPT-4 al preguntarle sobre el error arrojado al intentar usar el modelo `gpt-3.5-turbo`

El error que est√°s viendo indica que est√°s tratando de usar un modelo de chat (como gpt-3.5-turbo u otros modelos de chat) en el endpoint de "completions" (`v1/completions`) de la API de OpenAI, lo cual no es correcto para esos modelos.

Para solucionar este problema, deber√°s usar el endpoint `v1/chat/completions` en lugar de `v1/completions`.

Aqu√≠ te muestro c√≥mo puedes hacerlo:

1. Aseg√∫rate de tener instalada la biblioteca `openai`.
   
   Si no la tienes, inst√°lala con:
   ```bash
   pip install openai
   ```

2. Cambia tu c√≥digo para que use el endpoint correcto:

   ```python
   import openai

   # Configura tu API Key
   openai.api_key = 'TU_API_KEY'

   # Utiliza el endpoint correcto
   response = openai.ChatCompletion.create(
     model="gpt-3.5-turbo",
     messages=[
         {"role": "system", "content": "You are a helpful assistant."},
         {"role": "user", "content": "Who won the world series in 2020?"},
     ]
   )

   # Imprime la respuesta
   print(response.choices[0].message['content'])
   ```

En este ejemplo, en lugar de utilizar la funci√≥n `Completion` (que se usa para el endpoint `v1/completions`), estamos utilizando `ChatCompletion` para hacer peticiones al endpoint `v1/chat/completions`. Tambi√©n notar√°s que la estructura de entrada es diferente; en lugar de proporcionar un simple `prompt`, suministras una lista de `messages`.

Con estos cambios, deber√≠as poder interactuar con el modelo de chat sin problemas.

> Hacemos las correcciones y solicitamos generar un c√≥digo para mostrar una imagen con Python en Google Colab

![ChatCompletion en Python](./screenshots/c103/image-1.png)

> Respuesta en extra√≠da

![ChatCompletion extract content](./screenshots/c103/image-2.png)

Claro, aqu√≠ tienes un c√≥digo para generar una imagen y mostrarla en Google Colab utilizando la biblioteca PIL (Python Imaging Library):

```python
from PIL import Image
import matplotlib.pyplot as plt

# Crear una imagen en blanco de 200x200 p√≠xeles
imagen = Image.new("RGB", (200, 200), "white")

# Dibujar un rect√°ngulo rojo en la imagen
for i in range(50, 150):
    for j in range(50, 150):
        imagen.putpixel((i, j), (255, 0, 0))

# Mostrar la imagen en Google Colab
plt.imshow(imagen)
plt.axis('off')
plt.show()
```

Al ejecutar este c√≥digo, se generar√° una imagen en blanco con un rect√°ngulo rojo en el centro. Luego, la imagen se mostrar√° en la salida de la celda de c√≥digo en Google Colab.

### Flujo de Trabajo con CHATGPT via API

Vamos a establecer un flujo de trabajo para solicitarle a CHATGPT que resuelva tareas extra√≠das desde un archivo de texto y vaya colocando los resultados generados en documentos de Markdown. Luego solicitaremos a CHATGPT que nos genere el c√≥digo en Python para leer todos los archivos de Markdown y guardarlos en un PDF.

```py
#
# Por Alan Badillo Salas (alan@nomadacode.com)
# Creado el 11 de Agosto de 2023
#
# CHATGPT MARKDOWN FUNCTION WORKFLOW
#
# Esta funci√≥n lee un archivo con las instrucciones que debe procesar CHATGPT
# asumiendo un rol de como comportarse y generando un archivo de Markdown
# con los resultados generados.
#
# El archivo debe ser similar al siguiente ejemplo:
#
# APIKEY: YOUR_APIKEY
#
# OUTPUT: mi_respuesta.md
#
# ROLE: 
# ... Eres un programado de Python
#
# INSTRUCTIONS:
# ... Genera un programa en Python que muestre los primeros 10 n√∫meros primos
# ... Describe el c√≥digo paso por paso
# 
# * Este c√≥digo pertenece al curso de Introducci√≥n a CHATGPT con Python
#   del Centro de Investigaci√≥n en Computaci√≥n 
#   del Instituto Polit√©cnico Nacional
#

def chatgpt_md(file_instructions):
  import re
  with open(file_instructions, "r") as f:
    content = f.read()
    api_key = "YOUR_APIKEY"
    for match in re.finditer(r"APIKEY:\s*([^\n]*)", content):
      if match != None:
        api_key = match.group(1).strip()
    output_file = "output.md"
    for match in re.finditer(r"OUTPUT:\s*([^\n]*)", content):
      if match != None:
        output_file = match.group(1).strip()
    role = "CHATGPT ASSISTANT"
    for match in re.finditer(r"ROLE:\s*\n((...\s*[^\n]*\n)+)", content):
      if match != None:
        role = "\n".join(map(lambda s: s.strip(), match.group(1).split("...")[1:]))
    instructions = "HELLO WORLD"
    for match in re.finditer(r"INSTRUCTIONS:\s*\n((...\s*[^\n]*\n?)+)", content):
      if match != None:
        instructions = "\n".join(map(lambda s: s.strip(), match.group(1).split("...")[1:]))
    print("OUTPUT:", output_file)
    print("ROLE:")
    print(role)
    print("INSTRUCTIONS:")
    print(instructions)

    import openai

    openai.api_key = api_key

    # Utiliza el endpoint correcto
    response = openai.ChatCompletion.create(
      model="gpt-3.5-turbo",
      messages=[
          {"role": "system", "content": role},
          {"role": "user", "content": instructions},
      ]
    )

    i = 0
    for choice in response.choices:
      content = choice.message.content
      if i > 0:
        filename = re.sub(r"\.md", f"{i}.md", output_file)
      else:
        filename = output_file
      with open(output_file, "w") as g:
        g.writelines(content)
      i += 1
    print("OK")

chatgpt_md("/content/generar_numeros_primos.txt")
```

> Contenido de `generar_numeros_primos.txt`

```text
APIKEY: YOUR_APIKEY

OUTPUT: mi_respuesta.md

ROLE: 
... Eres un programado de Python

INSTRUCTIONS:
... Genera un programa en Python que muestre los primeros 10 n√∫meros primos
... Describe el c√≥digo paso por paso
```